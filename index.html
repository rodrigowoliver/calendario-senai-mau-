<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CalendÃ¡rio Escolar SENAI MauÃ¡</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --blue:#003b73;--red:#d4002a;--orange:#f5821f;--accent:#00a8e0;
  --bg:#eef1f5;--white:#fff;
  --g100:#f8f9fa;--g200:#e9ecef;--g300:#dee2e6;--g400:#adb5bd;--g600:#6c757d;--g800:#343a40;
  --c-wkend:#d6d6d6;--c-inicio:#ffd700;--c-pre:#c9a0dc;--c-fer:#4fc3f7;
  --c-fic:#ff9800;--c-nao:#b0bec5;--c-comp:#ef5350;--c-ferias:#a5d6a7;--c-semped:#ffb74d;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--g800);}
.hdr{background:linear-gradient(135deg,var(--blue) 0%,#005fa3 55%,var(--accent) 100%);padding:13px 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;box-shadow:0 4px 18px rgba(0,0,0,.3);}
.hdr-l{display:flex;align-items:center;gap:12px;}
.logo{background:#fff;border-radius:6px;padding:4px 10px;font-family:'Barlow Condensed',sans-serif;font-weight:800;font-size:18px;color:var(--red);}
.hdr-t{color:#fff;}
.hdr-t small{font-size:10px;opacity:.65;letter-spacing:2px;text-transform:uppercase;display:block;}
.hdr-t h1{font-family:'Barlow Condensed',sans-serif;font-size:21px;font-weight:800;line-height:1.1;}
.hdr-t h1 span{color:var(--orange);}
.hdr-r{display:flex;gap:7px;align-items:flex-end;flex-wrap:wrap;}
.cg{display:flex;flex-direction:column;gap:2px;}
.cg label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.55);font-weight:600;}
.cg select{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;padding:5px 12px;border-radius:5px;font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;cursor:pointer;outline:none;}
.cg select option{background:var(--blue);}
.btn{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.32);color:#fff;padding:5px 12px;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;}
.btn:hover{background:rgba(255,255,255,.28);}
.btn-edit{background:var(--orange);border-color:var(--orange);}
.btn-edit.active{background:#c8500a;border-color:#c8500a;box-shadow:0 0 0 2px #fff3;}
.leg{background:var(--white);padding:7px 20px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border-bottom:2px solid var(--g200);font-size:11px;}
.leg strong{font-family:'Barlow Condensed',sans-serif;font-size:12px;letter-spacing:1px;color:var(--g600);text-transform:uppercase;margin-right:2px;}
.li{display:flex;align-items:center;gap:5px;position:relative;padding:2px 4px;border-radius:4px;}
.li-txt{cursor:default;}
.sw{width:13px;height:13px;border-radius:3px;flex-shrink:0;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
body.editing .li{cursor:pointer;border:1px dashed transparent;}
body.editing .li:hover{border-color:var(--orange);background:#fff8f0;}
body.editing .li:hover .li-txt{text-decoration:underline dotted var(--orange);}
.li-del{display:none;position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;border-radius:50%;width:14px;height:14px;font-size:9px;line-height:14px;text-align:center;cursor:pointer;font-weight:700;z-index:2;}
body.editing .li:hover .li-del{display:block;}
.leg-add-btn{display:none;padding:3px 10px;border-radius:4px;font-size:10px;font-weight:700;color:var(--blue);background:#e8f4fd;border:1px dashed var(--accent);cursor:pointer;white-space:nowrap;}
body.editing .leg-add-btn{display:flex;align-items:center;gap:4px;}
.color-preset{display:inline-block;width:20px;height:20px;border-radius:4px;cursor:pointer;border:1px solid rgba(0,0,0,.15);flex-shrink:0;transition:transform .1s;}
.color-preset:hover{transform:scale(1.25);}
.edit-hint{background:#fff3cd;border-bottom:2px solid var(--orange);padding:7px 20px;font-size:12px;color:#856404;display:none;align-items:center;gap:10px;flex-wrap:wrap;}
.edit-hint.show{display:flex;}
.edit-hint strong{color:#c8500a;}
/* multi-select hint */
.sel-hint{background:#e8f4fd;border-bottom:2px solid var(--accent);padding:6px 20px;font-size:12px;color:#004f80;display:none;align-items:center;gap:10px;flex-wrap:wrap;}
.sel-hint.show{display:flex;}
.sel-hint strong{color:#003b73;}
.body{padding:13px 16px;max-width:1640px;margin:0 auto;}
.sem-block{margin-bottom:20px;}
.sem-lbl{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:#fff;background:var(--blue);display:inline-block;padding:4px 14px;border-radius:4px;margin-bottom:9px;}
.mgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:9px;}
@media(max-width:1100px){.mgrid{grid-template-columns:repeat(3,1fr);}}
@media(max-width:700px){.mgrid{grid-template-columns:repeat(2,1fr);}}
@media(max-width:480px){.mgrid{grid-template-columns:1fr;}}
.mc{background:var(--white);border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.08);display:flex;flex-direction:column;}
.mc-hdr{background:var(--blue);color:#fff;padding:7px 10px;display:flex;justify-content:space-between;align-items:center;}
.mc-hdr h2{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;text-transform:uppercase;}
.mc-hdr .badge{background:var(--orange);color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:20px;}
.cal-wrap{padding:5px 6px 2px;}
.ct{width:100%;border-collapse:collapse;}
.ct thead th{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.7px;text-align:center;padding:3px 1px 2px;color:var(--g600);border-bottom:1px solid var(--g200);}
.ct thead th.wh{color:var(--red);}
.ct tbody td{text-align:center;padding:2px 1px;font-size:11px;font-weight:500;line-height:1;user-select:none;}
.ct tbody td.emp{background:none;}
.d-wk{background:var(--c-wkend);-webkit-print-color-adjust:exact;print-color-adjust:exact;}
.d-i{background:var(--c-inicio);-webkit-print-color-adjust:exact;print-color-adjust:exact;}
.d-p{background:var(--c-pre);-webkit-print-color-adjust:exact;print-color-adjust:exact;}
.d-f{background:var(--c-fer);-webkit-print-color-adjust:exact;print-color-adjust:exact;}
.d-fc{background:var(--c-fic);color:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
.d-n{background:var(--c-nao);-webkit-print-color-adjust:exact;print-color-adjust:exact;}
.d-c{background:var(--c-comp);color:#fff;font-weight:700;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
.d-fer{background:var(--c-ferias);-webkit-print-color-adjust:exact;print-color-adjust:exact;}
.d-sp{background:var(--c-semped);-webkit-print-color-adjust:exact;print-color-adjust:exact;}
.dn{display:inline-block;width:21px;height:21px;line-height:21px;border-radius:50%;font-size:10.5px;}
body.editing .ct tbody td:not(.emp){cursor:pointer;}
body.editing .ct tbody td:not(.emp):hover .dn{outline:2px solid var(--orange);border-radius:50%;}
/* multi-select highlight */
.ct tbody td.multi-sel .dn{outline:3px solid var(--blue);border-radius:50%;background:rgba(0,59,115,.15);}
.tot-row{display:grid;grid-template-columns:repeat(7,1fr);background:var(--g100);border-top:2px solid var(--g200);padding:4px 6px;gap:1px;}
.tc{text-align:center;}
.tc .tl{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--g400);}
.tc .tn{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;color:var(--blue);line-height:1;}
.tc .tn.z{color:var(--g400);}
.mev{padding:6px 9px;background:var(--g100);border-top:1px solid var(--g200);font-size:10px;line-height:1.65;color:var(--g600);flex:1;overflow-y:auto;max-height:115px;}
.mev::-webkit-scrollbar{width:3px;}
.mev::-webkit-scrollbar-thumb{background:var(--g400);border-radius:3px;}
.mev p{display:flex;align-items:baseline;gap:3px;margin-bottom:1px;}
.ev-dot{width:5px;height:5px;border-radius:50%;background:var(--g400);flex-shrink:0;margin-top:3px;}
.ev-txt{flex:1;cursor:default;}
body.editing .ev-txt{cursor:pointer;text-decoration:underline dotted var(--g400);}
body.editing .ev-txt:hover{color:var(--blue);}
.ev-del{display:none;cursor:pointer;color:var(--red);font-size:10px;flex-shrink:0;margin-left:2px;}
body.editing .mev p:hover .ev-del{display:inline;}
.ev-add-row{display:none;padding:5px 9px;font-size:10px;font-weight:600;color:var(--blue);background:#e8f4fd;border-top:1px dashed var(--accent);cursor:pointer;text-align:center;}
body.editing .ev-add-row{display:block;}
.ev-add-row:hover{background:#d0eaf9;}
.bot{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-top:4px;}
.ic{background:var(--white);border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.07);}
.ic-hdr{background:var(--blue);color:#fff;padding:7px 13px;display:flex;justify-content:space-between;align-items:center;}
.ic-hdr h3{font-family:'Barlow Condensed',sans-serif;font-size:12px;letter-spacing:2px;text-transform:uppercase;}
.ic-hdr .ic-edit-btn{font-size:10px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;padding:2px 8px;border-radius:4px;cursor:pointer;display:none;}
body.editing .ic-edit-btn{display:block;}
.ic table{width:100%;border-collapse:collapse;font-size:11.5px;}
.ic th{background:var(--g200);padding:6px 9px;text-align:center;font-weight:700;font-size:11px;}
.ic td{padding:5px 9px;border-bottom:1px solid var(--g200);text-align:center;font-size:11px;}
.ic tr:last-child td{border-bottom:none;}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:center;justify-content:center;}
.overlay.show{display:flex;}
.modal{background:#fff;border-radius:12px;padding:22px;width:420px;max-width:96vw;box-shadow:0 12px 40px rgba(0,0,0,.3);}
.modal h3{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;color:var(--blue);margin-bottom:3px;}
.modal .dlbl{font-size:12px;color:var(--g600);margin-bottom:14px;}
.mlbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--g600);display:block;margin-bottom:6px;}
.type-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px;}
.tb{padding:8px 10px;border-radius:6px;cursor:pointer;font-size:11.5px;font-weight:600;text-align:center;transition:opacity .12s;}
.tb:hover{opacity:.82;}
.tb.sel{outline:3px solid var(--blue);outline-offset:1px;}
.desc-inp{width:100%;padding:7px 10px;border:1px solid var(--g200);border-radius:6px;font-size:13px;font-family:'Barlow',sans-serif;margin-bottom:14px;outline:none;}
.desc-inp:focus{border-color:var(--blue);}
.mbtns{display:flex;gap:7px;justify-content:flex-end;flex-wrap:wrap;}
.mbtn{padding:7px 16px;border-radius:6px;border:none;font-size:12px;font-weight:600;cursor:pointer;}
.mbtn-cancel{background:var(--g200);color:var(--g800);}
.mbtn-save{background:var(--blue);color:#fff;}
.mbtn-clear{background:#fff;color:var(--red);border:1px solid var(--red);margin-right:auto;}
.row-modal{background:#fff;border-radius:12px;padding:22px;width:560px;max-width:96vw;box-shadow:0 12px 40px rgba(0,0,0,.3);max-height:90vh;overflow-y:auto;}
.row-modal h3{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:700;color:var(--blue);margin-bottom:14px;}
.row-modal table{width:100%;border-collapse:collapse;margin-bottom:14px;font-size:12px;}
.row-modal th{background:var(--g200);padding:6px 8px;text-align:left;font-weight:700;}
.row-modal td{padding:4px 6px;border-bottom:1px solid var(--g200);vertical-align:middle;}
.row-modal td input{width:100%;border:1px solid var(--g300);border-radius:4px;padding:4px 6px;font-size:11.5px;font-family:'Barlow',sans-serif;outline:none;}
.row-modal td input:focus{border-color:var(--blue);}
.row-modal .add-row{font-size:11px;color:var(--blue);cursor:pointer;text-decoration:underline;margin-bottom:12px;display:inline-block;}
.row-modal .del-row{color:var(--red);cursor:pointer;font-size:12px;padding:2px 5px;}
@media(max-width:700px){
  .hdr{padding:10px 14px;}.hdr-t h1{font-size:17px;}.hdr-r{gap:5px;}
  .btn{padding:5px 8px;font-size:10px;}.body{padding:10px 10px;}.bot{grid-template-columns:1fr;}
  .ic table{font-size:10px;}.ic th,.ic td{padding:4px 6px;}
  .leg{padding:6px 12px;gap:7px;font-size:10.5px;}
  .dn{width:26px;height:26px;line-height:26px;font-size:12px;}
  .ct tbody td{padding:3px 1px;}.mev{max-height:150px;}
  .tot-row{padding:5px 8px;}.tc .tn{font-size:14px;}
}
footer{text-align:center;font-size:10.5px;color:var(--g400);padding:12px 0 16px;}
@media print{
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
  body{background:#fff;}.hdr{background:var(--blue)!important;}
  .btn-edit,.edit-hint,.sel-hint,.ev-del,.ic-edit-btn,.ev-add-row,.leg-add-btn,.li-del{display:none!important;}
  .mc{break-inside:avoid;box-shadow:none;border:1px solid var(--g200);}
  .body{padding:6px 8px;}.mgrid{gap:6px;}.leg{border-bottom:1px solid #ccc;}
  .bot{break-inside:avoid;}.ic{box-shadow:none;border:1px solid var(--g200);}
  .mev{max-height:none;overflow:visible;}
  .d-wk{background:var(--c-wkend)!important;}.d-i{background:var(--c-inicio)!important;}
  .d-p{background:var(--c-pre)!important;}.d-f{background:var(--c-fer)!important;}
  .d-fc{background:var(--c-fic)!important;color:#fff!important;}.d-n{background:var(--c-nao)!important;}
  .d-c{background:var(--c-comp)!important;color:#fff!important;}.d-fer{background:var(--c-ferias)!important;}
  .d-sp{background:var(--c-semped)!important;}.ic th{background:var(--g200)!important;}
  .ct tbody td.multi-sel .dn{outline:none;background:none;}
}
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-l">
    <div class="logo">SENAI</div>
    <div class="hdr-t">
      <small>Escola SENAI "Jairo Candido"</small>
      <h1>CALENDÃRIO ESCOLAR <span id="ty">2026</span></h1>
    </div>
  </div>
  <div class="hdr-r">
    <div class="cg"><label>Ano</label><select id="sy"></select></div>
    <button class="btn btn-edit" id="editBtn" onclick="toggleEdit()">âœï¸ Editar</button>
    <button class="btn" onclick="window.print()">ğŸ–¨ Imprimir</button>
    <button class="btn" onclick="exportData()">ğŸ’¾ Exportar</button>
    <button class="btn" onclick="importClick()">ğŸ“‚ Importar</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
  </div>
</div>

<div class="leg" id="legendBar">
  <strong>Legenda:</strong>
  <span class="leg-add-btn" onclick="openLegendAdd()">ï¼‹ Adicionar item</span>
</div>

<div class="edit-hint" id="editHint">
  <strong>âœï¸ MODO EDIÃ‡ÃƒO ATIVO</strong>
  Clique num dia para editar. <strong>Clique e arraste</strong> (ou clique em vÃ¡rios) para selecionar mÃºltiplos dias de uma vez.
  <button class="btn" style="margin-left:auto;padding:4px 11px;font-size:11px" onclick="toggleEdit()">âœ“ Concluir ediÃ§Ã£o</button>
</div>

<div class="sel-hint" id="selHint">
  <strong id="selCount">0 dias selecionados</strong> â€” clique num dia selecionado (azul) ou no botÃ£o para editar todos.
  <button class="btn" style="padding:4px 11px;font-size:11px;background:var(--blue);border-color:var(--blue);" onclick="openMultiModal()">âœï¸ Editar todos</button>
  <button class="btn" style="padding:4px 11px;font-size:11px;" onclick="clearSelection()">âœ• Cancelar</button>
</div>

<div class="body">
  <div class="sem-block">
    <div class="sem-lbl">1Âº Semestre â€” Janeiro a Junho</div>
    <div class="mgrid" id="g1"></div>
  </div>
  <div class="sem-block">
    <div class="sem-lbl">2Âº Semestre â€” Julho a Dezembro</div>
    <div class="mgrid" id="g2"></div>
  </div>
  <div class="bot">
    <div class="ic">
      <div class="ic-hdr">
        <h3>Dias a Compensar</h3>
        <span class="ic-edit-btn" onclick="openTableModal('comp')">âœï¸ Editar</span>
      </div>
      <div id="compBody"></div>
    </div>
    <div class="ic">
      <div class="ic-hdr">
        <h3>Cursos Â· InÃ­cio e TÃ©rmino</h3>
        <span class="ic-edit-btn" onclick="openTableModal('courses')">âœï¸ Editar</span>
      </div>
      <div id="coursesBody"></div>
    </div>
  </div>
  <footer>Obs.: Dias a compensar â€“ conforme acordo coletivo sindical SENAI SENALBA â€“ Inciso IV â€“ Jornada de trabalho â€“ Item 14 â€“ CompensaÃ§Ã£o de horas, Â§ 1 e 2</footer>
</div>

<!-- LEGEND MODAL -->
<div class="overlay" id="legendOverlay">
  <div class="modal" style="width:360px;">
    <h3 id="legTitle">Item da Legenda</h3>
    <div class="dlbl" id="legSubtitle">Edite a cor e o texto</div>
    <span class="mlbl">Cor</span>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:14px;flex-wrap:wrap;">
      <input type="color" id="legColor" style="width:44px;height:34px;border:1px solid #ccc;border-radius:6px;cursor:pointer;padding:2px;">
      <div style="display:flex;flex-wrap:wrap;gap:5px;flex:1;">
        <span class="color-preset" style="background:#fff;border:1px solid #ccc;" onclick="setLegColor('#ffffff')"></span>
        <span class="color-preset" style="background:var(--c-wkend);" onclick="setLegColor('#d6d6d6')"></span>
        <span class="color-preset" style="background:var(--c-inicio);" onclick="setLegColor('#ffd700')"></span>
        <span class="color-preset" style="background:var(--c-pre);" onclick="setLegColor('#c9a0dc')"></span>
        <span class="color-preset" style="background:var(--c-fer);" onclick="setLegColor('#4fc3f7')"></span>
        <span class="color-preset" style="background:var(--c-fic);" onclick="setLegColor('#ff9800')"></span>
        <span class="color-preset" style="background:var(--c-nao);" onclick="setLegColor('#b0bec5')"></span>
        <span class="color-preset" style="background:var(--c-comp);" onclick="setLegColor('#ef5350')"></span>
        <span class="color-preset" style="background:var(--c-ferias);" onclick="setLegColor('#a5d6a7')"></span>
        <span class="color-preset" style="background:var(--c-semped);" onclick="setLegColor('#ffb74d')"></span>
      </div>
    </div>
    <span class="mlbl">Texto</span>
    <input class="desc-inp" id="legText" type="text" placeholder="Ex: Dia Letivo">
    <div class="mbtns">
      <button class="mbtn mbtn-clear" id="legDelBtn" onclick="deleteLegItem()" style="display:none;">ğŸ—‘ Remover</button>
      <button class="mbtn mbtn-cancel" onclick="closeLegModal()">Cancelar</button>
      <button class="mbtn mbtn-save" onclick="saveLegItem()">Salvar</button>
    </div>
  </div>
</div>

<!-- DAY / MULTI-DAY MODAL -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h3 id="mTitle">Editar Dia</h3>
    <div class="dlbl" id="mDateLbl"></div>
    <span class="mlbl">Tipo do Dia</span>
    <div class="type-grid" id="typeGrid"></div>
    <span class="mlbl">DescriÃ§Ã£o</span>
    <input class="desc-inp" id="mDesc" type="text" placeholder="Ex: InÃ­cio perÃ­odo letivo â€“ CAI / CT SESI">
    <div class="mbtns">
      <button class="mbtn mbtn-clear" id="mClearBtn" onclick="clearDay()">ğŸ—‘ Limpar</button>
      <button class="mbtn mbtn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="mbtn mbtn-save" onclick="saveDay()">Salvar</button>
    </div>
  </div>
</div>

<!-- TABLE MODAL -->
<div class="overlay" id="tableOverlay">
  <div class="row-modal">
    <h3 id="tmTitle">Editar Tabela</h3>
    <table><thead id="tmHead"></thead><tbody id="tmBody"></tbody></table>
    <span class="add-row" onclick="addTmRow()">+ Adicionar linha</span>
    <div class="mbtns">
      <button class="mbtn mbtn-cancel" onclick="closeTm()">Cancelar</button>
      <button class="mbtn mbtn-save" onclick="saveTm()">Salvar</button>
    </div>
  </div>
</div>

<script>
const MN=['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const HDR=['D','2Âª','3Âª','4Âª','5Âª','6Âª','S'];
const COL2WD=[0,1,2,3,4,5,6];
// Types that do NOT count as letivo (weekdays only â€” weekends handled separately)
const NON_LETIVO=new Set(['d-f','d-n','d-c','d-fer','d-sp','d-wk']);
const WK_TYPE='d-wk';
const EDIT_PASSWORD='eusousenai';

const DEFAULT_LEGEND=[
  {type:'',     color:'#ffffff', border:true,  text:'Dia Letivo'},
  {type:'d-wk', color:'#d6d6d6', border:false, text:'Final de Semana'},
  {type:'d-i',  color:'#ffd700', border:false, text:'InÃ­cio / TÃ©rmino Semestre'},
  {type:'d-p',  color:'#c9a0dc', border:false, text:'PrÃ©-Conselho / Conselho'},
  {type:'d-f',  color:'#4fc3f7', border:false, text:'Feriado Nacional / Municipal'},
  {type:'d-fc', color:'#ff9800', border:false, text:'PerÃ­odo FIC'},
  {type:'d-n',  color:'#b0bec5', border:false, text:'NÃ£o Letivo'},
  {type:'d-c',  color:'#ef5350', border:false, text:'CompensaÃ§Ã£o'},
  {type:'d-fer',color:'#a5d6a7', border:false, text:'FÃ©rias Docente'},
  {type:'d-sp', color:'#ffb74d', border:false, text:'Semana PedagÃ³gica'},
];

// â”€â”€ Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadAll(){try{return JSON.parse(localStorage.getItem('senai_cal')||'{}');}catch{return{};}}
function saveAll(d){localStorage.setItem('senai_cal',JSON.stringify(d));}
function getLegendData(){
  const a=loadAll();
  if(!a['_legend'])return JSON.parse(JSON.stringify(DEFAULT_LEGEND));
  return a['_legend'].map((it,i)=>{if(it.type===undefined)it.type=DEFAULT_LEGEND[i]?DEFAULT_LEGEND[i].type:'';return it;});
}
function setLegendData(items){const a=loadAll();a['_legend']=items;saveAll(a);}
function getUserYear(y){const a=loadAll();return a[String(y)]||{};}
function setUserDay(y,key,entry){
  const a=loadAll();const ky=String(y);if(!a[ky])a[ky]={};
  if(entry===null)delete a[ky][key];else a[ky][key]=entry;saveAll(a);
}

// â”€â”€ Easter & date utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function easter(y){const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),mo=Math.floor((h+l-7*m+114)/31),dy=((h+l-7*m+114)%31)+1;return new Date(y,mo-1,dy);}
function addD(dt,n){return new Date(dt.getTime()+n*86400000);}
function gmd(dt){return{m:dt.getMonth()+1,d:dt.getDate()};}
function dk(y,m,d){return`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;}
function dkParse(k){const[y,m,d]=k.split('-').map(Number);return{y,m,d};}

// â”€â”€ Base special days â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function baseSD(year){
  const sd={};
  function A(m,d,t,l=''){const k=dk(year,m,d);if(!sd[k])sd[k]={t,l};else{sd[k].t=t;if(l)sd[k].l+=(sd[k].l?'; ':'')+l;}}
  const e=easter(year),sx=addD(e,-2),co=addD(e,60),c1=addD(e,-48),c2=addD(e,-47);
  A(1,1,'d-f','ConfraternizaÃ§Ã£o Universal');A(4,21,'d-f','Tiradentes');A(5,1,'d-f','Dia Mundial do Trabalho');
  A(9,7,'d-f','ProclamaÃ§Ã£o da IndependÃªncia');A(10,12,'d-f','Padroeira do Brasil');A(11,2,'d-f','Finados');
  A(11,15,'d-f','ProclamaÃ§Ã£o da RepÃºblica');A(11,20,'d-n','Dia da ConsciÃªncia Negra');A(12,25,'d-f','Natal');
  let r=gmd(sx);A(r.m,r.d,'d-f','PaixÃ£o de Cristo');r=gmd(e);A(r.m,r.d,'d-f','PÃ¡scoa');
  r=gmd(co);A(r.m,r.d,'d-f','Corpus Christi');r=gmd(c1);A(r.m,r.d,'d-f','Carnaval');r=gmd(c2);A(r.m,r.d,'d-f','Carnaval');
  A(1,2,'d-c','Compensar â€“ Todos');A(1,3,'d-c','Compensar â€“ FIC');
  A(1,5,'d-fer','FÃ©rias Docente');A(1,6,'d-fer','FÃ©rias Docente');A(1,7,'d-fer','FÃ©rias Docente');A(1,8,'d-fer','FÃ©rias Docente');A(1,9,'d-fer','FÃ©rias Docente');
  A(1,12,'d-fc','InÃ­cio perÃ­odo letivo â€“ FIC');
  A(1,19,'d-sp','Semana PedagÃ³gica');A(1,20,'d-sp','Semana PedagÃ³gica');A(1,21,'d-sp','Semana PedagÃ³gica');A(1,22,'d-sp','Semana PedagÃ³gica');A(1,23,'d-sp','Semana PedagÃ³gica');
  A(1,26,'d-i','InÃ­cio perÃ­odo letivo â€“ CAI / CT SESI');A(2,2,'d-i','InÃ­cio perÃ­odo letivo â€“ CT SEDUC');
  A(2,14,'d-c','Compensar â€“ FIC');A(2,23,'d-i','InÃ­cio perÃ­odo letivo â€“ CT Autonomia e Renda');
  A(2,24,'d-p','ReuniÃ£o CIPA / Brigada / NPAADC');A(2,26,'d-p','ReuniÃ£o do Conselho Escolar');
  A(3,27,'d-p','ReuniÃ£o CIPA / Brigada / NPAADC');
  A(4,4,'d-c','Compensar â€“ FIC');A(4,11,'d-c','Compensar 20/04');A(4,18,'d-c','Compensar â€“ FIC');A(4,20,'d-n','NÃ£o Letivo');
  A(4,27,'d-i','InÃ­cio perÃ­odo letivo â€“ PPJA');A(4,30,'d-p','ReuniÃ£o CIPA / Brigada / NPAADC');
  A(5,2,'d-c','Compensar â€“ FIC');A(5,25,'d-n','Dia da IndÃºstria');A(5,26,'d-p','ReuniÃ£o CIPA / Brigada / NPAADC');
  A(6,5,'d-c','Compensar â€“ Todos');A(6,6,'d-c','Compensar â€“ FIC');A(6,12,'d-fc','FIC â€“ perÃ­odo');
  A(6,22,'d-p','ReuniÃ£o CIPA / Brigada');A(6,23,'d-i','TÃ©rmino â€“ CT SESI / CT SEDUC / CAI');
  A(6,24,'d-fer','FÃ©rias Docente');A(6,25,'d-fer','FÃ©rias Docente');A(6,26,'d-fer','FÃ©rias Docente');A(6,29,'d-fer','FÃ©rias Docente');A(6,30,'d-fer','FÃ©rias Docente');
  A(7,1,'d-fer','FÃ©rias Docente');A(7,2,'d-fer','FÃ©rias Docente');A(7,3,'d-fer','FÃ©rias Docente');A(7,6,'d-fer','FÃ©rias Docente');A(7,7,'d-fer','FÃ©rias Docente');A(7,8,'d-fer','FÃ©rias Docente');
  A(7,9,'d-f','RevoluÃ§Ã£o Constitucionalista');A(7,10,'d-fer','FÃ©rias Docente');A(7,13,'d-fer','FÃ©rias Docente');
  A(7,14,'d-sp','Semana PedagÃ³gica / InÃ­cio PPJA');A(7,15,'d-sp','Semana PedagÃ³gica / ReuniÃ£o TÃ©cnico-PedagÃ³gica');
  A(7,16,'d-sp','Semana PedagÃ³gica');A(7,17,'d-sp','Semana PedagÃ³gica');A(7,18,'d-sp','Semana PedagÃ³gica');
  A(7,28,'d-i','InÃ­cio perÃ­odo letivo â€“ CAI / CT SESI');A(7,29,'d-i','InÃ­cio perÃ­odo letivo â€“ CT SEDUC');
  A(7,30,'d-p','ReuniÃ£o CIPA / Brigada / NPAADC');A(8,1,'d-i','InÃ­cio perÃ­odo letivo â€“ Op. Polivalente');
  A(8,27,'d-p','ReuniÃ£o CIPA / Brigada / NPAADC');A(9,1,'d-i','TÃ©rmino perÃ­odo letivo â€“ PPJA');A(9,2,'d-i','InÃ­cio perÃ­odo letivo â€“ PPJA');
  A(9,24,'d-p','ReuniÃ£o CIPA / Brigada / NPAADC');A(10,15,'d-n','Dia do Professor');A(10,29,'d-p','ReuniÃ£o CIPA / Brigada / NPAADC');
  A(11,19,'d-n','Dia da Bandeira');A(11,21,'d-c','Compensar â€“ Todos');A(11,22,'d-c','Compensar â€“ FIC');
  A(11,25,'d-p','ReuniÃ£o do Conselho Escolar');A(11,26,'d-p','ReuniÃ£o CIPA / Brigada / NPAADC');
  A(12,8,'d-f','Feriado Municipal â€“ AniversÃ¡rio de MauÃ¡');A(12,15,'d-i','TÃ©rmino â€“ CT SEDUC');
  A(12,16,'d-i','Formatura â€“ CAI / PPJA / CT SESI');A(12,18,'d-i','TÃ©rmino â€“ CAI / CT SESI / FIC');
  A(12,19,'d-p','ReuniÃ£o CIPA / Brigada / NPAADC');A(12,26,'d-i','TÃ©rmino â€“ PPJA');
  A(12,22,'d-fer','FÃ©rias Docente');A(12,23,'d-fer','FÃ©rias Docente');A(12,29,'d-fer','FÃ©rias Docente');A(12,30,'d-fer','FÃ©rias Docente');A(12,31,'d-fer','FÃ©rias Docente');
  return sd;
}

function mergedSD(year){
  const sd=baseSD(year),user=getUserYear(year);
  Object.entries(user).forEach(([k,v])=>{if(v===null||v.t==='')delete sd[k];else sd[k]=v;});
  return sd;
}

// â”€â”€ Count letivos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// A day is letivo if:
//   â€¢ It has no special type (blank = letivo), OR
//   â€¢ It has a type that is NOT in NON_LETIVO
// Weekends default to d-wk (NON_LETIVO) but count as letivo if user sets a non-NON_LETIVO type
function calcL(year,month,sd){
  const dim=new Date(year,month,0).getDate();
  let total=0;const byWD=[0,0,0,0,0,0,0];
  for(let d=1;d<=dim;d++){
    const wd=new Date(year,month-1,d).getDay();
    const k=dk(year,month,d);
    const sp=sd[k];
    // effective type: user override or default weekend type or '' (letivo)
    const effType=sp?sp.t:(wd===0||wd===6?WK_TYPE:'');
    if(NON_LETIVO.has(effType))continue;
    total++;byWD[wd]++;
  }
  return{total,byWD};
}

// â”€â”€ Build month card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMonth(year,month,sd){
  const dim=new Date(year,month,0).getDate();
  const fd=new Date(year,month-1,1).getDay();
  const{total,byWD}=calcL(year,month,sd);
  let cal=`<table class="ct"><thead><tr>`;
  HDR.forEach((h,i)=>cal+=`<th class="${(i===0||i===6)?'wh':''}">${h}</th>`);
  cal+=`</tr></thead><tbody><tr>`;
  for(let i=0;i<fd;i++)cal+=`<td class="emp"></td>`;
  let col=fd;
  for(let d=1;d<=dim;d++){
    const wd=new Date(year,month-1,d).getDay();
    const k=dk(year,month,d);const sp=sd[k];
    // default: weekend = d-wk, weekday = ''
    let cls=(wd===0||wd===6)?WK_TYPE:'';
    if(sp)cls=sp.t; // user override always wins
    const ttl=sp&&sp.l?` title="${sp.l}"`:'';;
    cal+=`<td class="${cls}"${ttl} data-key="${k}" onmousedown="dayMouseDown(event,this)" onmouseenter="dayMouseEnter(this)" onmouseup="dayMouseUp(event,this)" onclick="dayClick(event,this)"><span class="dn">${d}</span></td>`;
    col++;if(col===7&&d<dim){cal+=`</tr><tr>`;col=0;}
  }
  if(col>0&&col<7)for(let i=col;i<7;i++)cal+=`<td class="emp"></td>`;
  cal+=`</tr></tbody></table>`;
  let tots=`<div class="tot-row">`;
  HDR.forEach((_,ci)=>{const wd=COL2WD[ci];const n=byWD[wd]||0;tots+=`<div class="tc"><div class="tl">${HDR[ci]}</div><div class="tn${n===0?' z':''}">${n===0?'â€“':n}</div></div>`;});
  tots+=`</div>`;
  let evHtml='';
  for(let d=1;d<=dim;d++){
    const k=dk(year,month,d);
    if(sd[k]&&sd[k].l)evHtml+=`<p><span class="ev-dot"></span><span class="ev-txt" data-key="${k}" onclick="editEvtText(event,this)">${String(d).padStart(2,'0')} â€“ ${sd[k].l}</span><span class="ev-del" data-key="${k}" onclick="delEvt(event,this)">âœ•</span></p>`;
  }
  if(!evHtml)evHtml='<p style="color:#bbb">â€”</p>';
  return`<div class="mc" id="mc-${year}-${month}">
    <div class="mc-hdr"><h2>${MN[month-1]}</h2><span class="badge">${total} letivos</span></div>
    <div class="cal-wrap">${cal}</div>${tots}
    <div class="mev" id="mev-${year}-${month}">${evHtml}</div>
    <div class="ev-add-row" data-year="${year}" data-month="${month}" onclick="openAddEvt(this)">ï¼‹ Adicionar evento</div>
  </div>`;
}

// â”€â”€ Type grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isLight(hex){
  try{const c=(hex||'ffffff').replace('#','').padEnd(6,'0');const r=parseInt(c.substr(0,2),16),g=parseInt(c.substr(2,2),16),b=parseInt(c.substr(4,2),16);return(r*299+g*587+b*114)/1000>145;}catch{return true;}
}
function renderTypeGrid(selT){
  const grid=document.getElementById('typeGrid');if(!grid)return;
  // Include d-wk so weekends can be reset to default weekend color
  const items=getLegendData();
  grid.innerHTML=items.map(item=>{
    const bg=item.color||'#ffffff';
    const fg=isLight(bg)?'#333':'#fff';
    const bdr=item.border?'border:2px solid #ccc;':'border:2px solid transparent;';
    const sel=(selT!==undefined&&item.type===(selT||''))?'sel':'';
    return`<div class="tb ${sel}" data-t="${item.type}" onclick="selTypeBtn(this)" style="background:${bg};color:${fg};${bdr}">${item.text}</div>`;
  }).join('');
}

// â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLegend(){
  const items=getLegendData();
  const bar=document.getElementById('legendBar');
  bar.querySelectorAll('.li').forEach(el=>el.remove());
  const addBtn=bar.querySelector('.leg-add-btn');
  items.forEach((item,idx)=>{
    const div=document.createElement('div');
    div.className='li';div.dataset.idx=idx;div.onclick=()=>openLegendEdit(idx);
    const bdr=item.border?'border:1px solid #ccc;':'border:1px solid rgba(0,0,0,.14);';
    div.innerHTML=`<div class="sw" style="background:${item.color};${bdr}"></div>`+
      `<span class="li-txt">${item.text}</span>`+
      `<span class="li-del" onclick="event.stopPropagation();deleteLegItemIdx(${idx})">âœ•</span>`;
    bar.insertBefore(div,addBtn);
  });
}
let legEditIdx=null;
function openLegendEdit(idx){
  if(!editMode)return;legEditIdx=idx;
  const item=getLegendData()[idx];
  document.getElementById('legTitle').textContent='Editar item da legenda';
  document.getElementById('legSubtitle').textContent='Altere a cor e o texto';
  document.getElementById('legColor').value=item.color;
  document.getElementById('legText').value=item.text;
  document.getElementById('legDelBtn').style.display='block';
  document.getElementById('legendOverlay').classList.add('show');
  setTimeout(()=>document.getElementById('legText').focus(),80);
}
function openLegendAdd(){
  if(!editMode)return;legEditIdx=null;
  document.getElementById('legTitle').textContent='Adicionar item Ã  legenda';
  document.getElementById('legSubtitle').textContent='Escolha uma cor e escreva o texto';
  document.getElementById('legColor').value='#ffffff';
  document.getElementById('legText').value='';
  document.getElementById('legDelBtn').style.display='none';
  document.getElementById('legendOverlay').classList.add('show');
  setTimeout(()=>document.getElementById('legText').focus(),80);
}
function setLegColor(hex){document.getElementById('legColor').value=hex;}
function saveLegItem(){
  const color=document.getElementById('legColor').value;
  const text=document.getElementById('legText').value.trim();
  if(!text)return;
  const items=getLegendData();const bdr=color==='#ffffff'||color==='#fff';
  if(legEditIdx!==null){
    items[legEditIdx]={type:items[legEditIdx].type||'',color,border:bdr,text};
  }else{
    items.push({type:'d-x'+Date.now(),color,border:bdr,text});
  }
  setLegendData(items);closeLegModal();renderLegend();
}
function deleteLegItem(){if(legEditIdx===null)return;deleteLegItemIdx(legEditIdx);closeLegModal();}
function deleteLegItemIdx(idx){const items=getLegendData();items.splice(idx,1);setLegendData(items);renderLegend();}
function closeLegModal(){document.getElementById('legendOverlay').classList.remove('show');legEditIdx=null;}
document.getElementById('legendOverlay').addEventListener('click',e=>{if(e.target===document.getElementById('legendOverlay'))closeLegModal();});
document.getElementById('legText').addEventListener('keydown',e=>{if(e.key==='Enter')saveLegItem();});

// â”€â”€ Edit mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editMode=false;
function toggleEdit(){
  if(!editMode){
    const pwd=prompt('ğŸ”’ Digite a senha para entrar no modo ediÃ§Ã£o:');
    if(pwd===null)return;
    if(pwd.trim()!==EDIT_PASSWORD){alert('âŒ Senha incorreta. Acesso negado.');return;}
  }
  editMode=!editMode;
  document.body.classList.toggle('editing',editMode);
  document.getElementById('editBtn').classList.toggle('active',editMode);
  document.getElementById('editHint').classList.toggle('show',editMode);
  if(!editMode)clearSelection();
}

// â”€â”€ Multi-select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedKeys=new Set();
let isDragging=false;
let dragStartKey=null;

function dayMouseDown(e,td){
  if(!editMode||e.button!==0)return;
  if(e.shiftKey){
    // shift+click: toggle this day without clearing others
    toggleDaySelect(td);
    e.preventDefault();
    return;
  }
  isDragging=true;
  dragStartKey=td.dataset.key;
  // If clicking an already-selected day alone (no shift), open editor
  // We'll decide in mouseup
}

function dayMouseEnter(td){
  if(!editMode||!isDragging)return;
  toggleDaySelect(td,true); // add to selection while dragging
}

function dayMouseUp(e,td){
  if(!editMode)return;
  isDragging=false;
}

function dayClick(e,td){
  if(!editMode)return;
  if(e.shiftKey)return;
  const k=td.dataset.key;
  if(selectedKeys.size>0){
    if(selectedKeys.has(k)){
      // Clicking a selected day opens the multi modal
      openMultiModal();
    }else{
      selectedKeys.add(k);td.classList.add('multi-sel');
      updateSelHint();
    }
    return;
  }
  openSingleDayModal(k);
}

function toggleDaySelect(td,onlyAdd){
  if(!td.dataset.key)return;
  const k=td.dataset.key;
  if(onlyAdd){
    selectedKeys.add(k);td.classList.add('multi-sel');
  }else{
    if(selectedKeys.has(k)){selectedKeys.delete(k);td.classList.remove('multi-sel');}
    else{selectedKeys.add(k);td.classList.add('multi-sel');}
  }
  updateSelHint();
}

function updateSelHint(){
  const hint=document.getElementById('selHint');
  const n=selectedKeys.size;
  if(n>0){
    hint.classList.add('show');
    document.getElementById('selCount').textContent=`${n} dia${n>1?'s':''} selecionado${n>1?'s':''}`;
  }else{
    hint.classList.remove('show');
  }
}

function clearSelection(){
  selectedKeys.forEach(k=>{
    const td=document.querySelector(`[data-key="${k}"]`);
    if(td)td.classList.remove('multi-sel');
  });
  selectedKeys.clear();
  updateSelHint();
}

// Stop drag on mouseup anywhere
document.addEventListener('mouseup',()=>{isDragging=false;});
// Prevent text selection while dragging over calendar
document.addEventListener('mousemove',e=>{if(isDragging)e.preventDefault();});

// â”€â”€ Day modal (single) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let curKey=null,curYear=null,addEvtYear=null,addEvtMonth=null,multiMode=false;

function selTypeBtn(btn){
  document.querySelectorAll('#typeGrid .tb').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
  const descInp=document.getElementById('mDesc');
  if(descInp.value.trim()===''){
    descInp.value=btn.textContent.trim();
    descInp.focus();descInp.setSelectionRange(descInp.value.length,descInp.value.length);
  }
}

function openSingleDayModal(key){
  multiMode=false;
  curKey=key;curYear=parseInt(document.getElementById('sy').value);
  addEvtYear=null;addEvtMonth=null;
  const{y,m,d}=dkParse(key);
  const sp=mergedSD(curYear)[key]||{t:'',l:''};
  document.getElementById('mTitle').textContent=`Editar â€“ ${String(d).padStart(2,'0')} de ${MN[m-1]} de ${y}`;
  document.getElementById('mDateLbl').textContent='Selecione o tipo e adicione uma descriÃ§Ã£o';
  document.getElementById('mClearBtn').style.display='';
  renderTypeGrid(sp.t);
  document.getElementById('mDesc').value=sp.l||'';
  document.getElementById('overlay').classList.add('show');
  setTimeout(()=>document.getElementById('mDesc').focus(),100);
}

function openMultiModal(){
  if(selectedKeys.size===0)return;
  multiMode=true;
  curKey=null;addEvtYear=null;addEvtMonth=null;
  curYear=parseInt(document.getElementById('sy').value);
  const n=selectedKeys.size;
  document.getElementById('mTitle').textContent=`Editar ${n} dia${n>1?'s':''}`;
  document.getElementById('mDateLbl').textContent='O tipo e a descriÃ§Ã£o serÃ£o aplicados em todos os dias selecionados';
  document.getElementById('mClearBtn').style.display='none'; // clear doesn't make sense for multi
  renderTypeGrid('');
  document.getElementById('mDesc').value='';
  document.getElementById('overlay').classList.add('show');
  setTimeout(()=>document.getElementById('mDesc').focus(),100);
}

function editEvtText(e,el){
  e.stopPropagation();if(!editMode)return;
  if(selectedKeys.size>0)return; // don't interfere with selection
  const key=el.dataset.key;
  openSingleDayModal(key);
}

function openAddEvt(el){
  if(!editMode)return;
  addEvtYear=parseInt(el.dataset.year);addEvtMonth=parseInt(el.dataset.month);
  curKey=null;curYear=addEvtYear;multiMode=false;
  document.getElementById('mTitle').textContent=`Adicionar evento â€“ ${MN[addEvtMonth-1]}`;
  document.getElementById('mDateLbl').innerHTML=`Dia: <input id="addDay" type="number" min="1" max="31" placeholder="ex: 15" style="width:60px;border:1px solid #ccc;border-radius:4px;padding:3px 6px;font-size:13px;margin-left:4px;">`;
  document.getElementById('mClearBtn').style.display='none';
  renderTypeGrid('');
  document.getElementById('mDesc').value='';
  document.getElementById('overlay').classList.add('show');
  setTimeout(()=>document.getElementById('addDay').focus(),100);
}

function closeModal(){document.getElementById('overlay').classList.remove('show');curKey=null;multiMode=false;}

function clearDay(){
  if(!curKey)return;
  setUserDay(curYear,curKey,null);
  closeModal();render();
}

function saveDay(){
  const t=document.querySelector('#typeGrid .tb.sel')?.dataset.t;
  const l=document.getElementById('mDesc').value.trim();
  const tVal=(t===undefined||t===null)?'':t;

  if(multiMode){
    // Apply to all selected keys
    selectedKeys.forEach(k=>{
      setUserDay(curYear,k,(tVal===''&&l==='')?null:{t:tVal,l});
    });
    clearSelection();
    closeModal();render();return;
  }

  if(curKey){
    setUserDay(curYear,curKey,(tVal===''&&l==='')?null:{t:tVal,l});
    closeModal();render();return;
  }

  if(addEvtYear&&addEvtMonth){
    const dayVal=parseInt(document.getElementById('addDay')?.value||'0');
    if(!dayVal||dayVal<1||dayVal>31){document.getElementById('addDay').style.borderColor='red';document.getElementById('addDay').focus();return;}
    const k=dk(addEvtYear,addEvtMonth,dayVal);
    const existing=mergedSD(addEvtYear)[k];
    setUserDay(addEvtYear,k,{t:tVal||(existing?existing.t:''),l});
    addEvtYear=null;addEvtMonth=null;closeModal();render();
  }
}

function delEvt(e,el){
  e.stopPropagation();if(!editMode)return;
  const year=parseInt(document.getElementById('sy').value);
  const k=el.dataset.key;const ex=mergedSD(year)[k];
  if(ex){const a=loadAll();const ky=String(year);if(!a[ky])a[ky]={};a[ky][k]={t:ex.t,l:''};saveAll(a);}
  render();
}
document.getElementById('overlay').addEventListener('click',e=>{if(e.target===document.getElementById('overlay'))closeModal();});
document.getElementById('mDesc').addEventListener('keydown',e=>{if(e.key==='Enter')saveDay();});

// â”€â”€ Table modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tmMode=null;
const TM_DEFS={
  comp:{title:'Editar â€“ Dias a Compensar',heads:['Dias a Compensar','CompensaÃ§Ã£o Regular','CompensaÃ§Ã£o FIC'],
    defaultRows:y=>[[`02/01/${y}`,`01â€“31/01`,`01â€“31/01`],[`03/01/${y}`,'â€“',`01â€“31/01`],[`14/02/${y}`,'â€“',`01â€“28/02`],[`04 e 18/04/${y}`,`11/04/${y}`,`01â€“30/04`],[`20/04/${y}`,`11/04/${y}`,`01â€“30/04`],[`02/05/${y}`,'â€“',`01â€“31/05`],[`05/06/${y}`,`01â€“30/06`,`01â€“30/06`],[`06/06/${y}`,'â€“',`01â€“30/06`],[`21/11/${y}`,`03â€“28/11`,`03â€“28/11`],[`22/11/${y}`,'â€“',`03â€“28/11`]]},
  courses:{title:'Editar â€“ Cursos Â· InÃ­cio e TÃ©rmino',heads:['Curso','InÃ­cio','TÃ©rmino M/T','TÃ©rmino N'],
    defaultRows:y=>[['CAI e CT SESI',`26/01/${y}`,`18/12/${y}`,`18/12/${y}`],['CT SEDUC',`02/02/${y}`,`15/12/${y}`,'â€“'],['CT Aut. e Renda',`23/02/${y}`,'â€“','â€“'],['PPJA',`14/07/${y}`,`26/12/${y}`,`18/12/${y}`],['FIC 1Âº sem',`12/01/${y}`,`23/06/${y}`,`23/06/${y}`],['FIC 2Âº sem','â€“',`18/12/${y}`,`18/12/${y}`],['Op. Polivalente',`01/08/${y}`,'â€“','â€“']]}
};
function getTableData(mode,year){const a=loadAll();return a[`_table_${mode}`]||TM_DEFS[mode].defaultRows(year);}
function setTableData(mode,rows){const a=loadAll();a[`_table_${mode}`]=rows;saveAll(a);}
function openTableModal(mode){
  if(!editMode)return;tmMode=mode;
  const year=parseInt(document.getElementById('sy').value);
  const def=TM_DEFS[mode];const rows=getTableData(mode,year);
  document.getElementById('tmTitle').textContent=def.title;
  document.getElementById('tmHead').innerHTML=`<tr><th></th>${def.heads.map(h=>`<th>${h}</th>`).join('')}</tr>`;
  renderTmBody(rows);document.getElementById('tableOverlay').classList.add('show');
}
function renderTmBody(rows){
  document.getElementById('tmBody').innerHTML=rows.map((row,ri)=>
    `<tr><td><span class="del-row" onclick="delTmRow(${ri})">âœ•</span></td>${row.map((cell,ci)=>`<td><input type="text" value="${String(cell).replace(/"/g,'&quot;')}" data-r="${ri}" data-c="${ci}"></td>`).join('')}</tr>`).join('');
}
function addTmRow(){const year=parseInt(document.getElementById('sy').value);const rows=getTableData(tmMode,year);rows.push(Array(TM_DEFS[tmMode].heads.length).fill(''));renderTmBody(rows);}
function delTmRow(ri){const year=parseInt(document.getElementById('sy').value);const rows=getTableData(tmMode,year);rows.splice(ri,1);renderTmBody(rows);}
function saveTm(){
  const inputs=document.querySelectorAll('#tmBody input');const rowMap={};
  inputs.forEach(inp=>{const r=inp.dataset.r,c=inp.dataset.c;if(!rowMap[r])rowMap[r]=[];rowMap[r][c]=inp.value;});
  setTableData(tmMode,Object.values(rowMap));closeTm();render();
}
function closeTm(){document.getElementById('tableOverlay').classList.remove('show');tmMode=null;}
document.getElementById('tableOverlay').addEventListener('click',e=>{if(e.target===document.getElementById('tableOverlay'))closeTm();});

// â”€â”€ Bottom tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(mode,year){
  const def=TM_DEFS[mode];const rows=getTableData(mode,year);
  const el=document.getElementById(mode==='comp'?'compBody':'coursesBody');
  el.innerHTML=`<table><thead><tr>${def.heads.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${rows.map(row=>`<tr>${row.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
}

// â”€â”€ Export / Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportData(){const blob=new Blob([JSON.stringify(loadAll(),null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='senai_calendario_backup.json';a.click();}
function importClick(){document.getElementById('importFile').click();}
function importData(e){const file=e.target.files[0];if(!file)return;const r=new FileReader();r.onload=ev=>{try{saveAll(JSON.parse(ev.target.result));render();alert('âœ… Importado com sucesso!');}catch{alert('âŒ Arquivo invÃ¡lido.');}};r.readAsText(file);e.target.value='';}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  const year=parseInt(document.getElementById('sy').value);
  document.getElementById('ty').textContent=year;
  const sd=mergedSD(year);
  let g1='',g2='';
  for(let m=1;m<=6;m++)g1+=buildMonth(year,m,sd);
  for(let m=7;m<=12;m++)g2+=buildMonth(year,m,sd);
  document.getElementById('g1').innerHTML=g1;
  document.getElementById('g2').innerHTML=g2;
  renderTable('comp',year);
  renderTable('courses',year);
  renderLegend();
  // Re-apply multi-select highlights after re-render
  selectedKeys.forEach(k=>{
    const td=document.querySelector(`[data-key="${k}"]`);
    if(td)td.classList.add('multi-sel');
  });
  updateSelHint();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const sy=document.getElementById('sy');
const cur=new Date().getFullYear();
for(let y=cur-3;y<=cur+6;y++){
  const o=document.createElement('option');o.value=y;o.textContent=y;
  if(y===2026)o.selected=true;sy.appendChild(o);
}
sy.addEventListener('change',render);
render();
</script>
</body>
</html>
